<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-title" content="SSL Evaluation">
    <link rel="manifest" href="manifest.json">
    <!--    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
            <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
            <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png"> -->

    <title>Sports Evaluation Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.877);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }

        .section {
            padding: 20px;
            display: none;
        }

        .section.active {
            display: block;
        }

        .setup-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .setup-row label {
            font-weight: 600;
            min-width: 100px;
        }

        .setup-row input,
        .setup-row select {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s;
            margin-bottom: 10px;
        }

        .m-0 {
            margin: 0px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-small {
            width: auto;
            padding: 6px 15px;
            font-size: 14px;
        }

        .group-list {
            margin: 20px 0;
        }

        .group-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .group-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .group-name {
            font-weight: 700;
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .group-info {
            font-size: 14px;
            color: #666;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-actions {
            display: flex;
            gap: 5px;
        }

        .participant-list {
            margin: 20px 0;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .participant-item input {
            flex: 1;
            border: 1px solid #ddd;
            padding: 6px 10px;
            border-radius: 4px;
        }

        .participant-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .participant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .participant-name {
            font-weight: 700;
            font-size: 18px;
            color: #2c3e50;
        }

        .level-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .level-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e8e);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .level-select {
            padding: 4px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .objectives-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .objective-item {
            display: flex;
            align-items: center;
            text-align: justify;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 8px;
            font-size: 14px;
        }

        .objective-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .objective-checkbox.checked {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .objective-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .objective-text {
            flex: 1;
            cursor: pointer;
        }

        .name-button {
            flex: 1;
            cursor: pointer;
        }

        .info-icon {
            width: 20px;
            height: 20px;
            margin-left: 20px;
            background: #17a2b8;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
        }

        .summary {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            margin-top: 10px;
            font-weight: 600;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .nav-buttons .btn {
            margin-bottom: 0;
            flex: 1;
        }

        .view-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .view-toggle button {
            flex: 1;
            padding: 10px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .view-toggle button.active {
            background: #667eea;
            color: white;
        }

        /* Objective-centered view styles */
        .objective-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .objective-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .objective-title {
            font-weight: 700;
            font-size: 16px;
            color: #2c3e50;
            flex: 1;
        }

        .level-group {
            margin-bottom: 15px;
            text-align: justify;
        }

        .level-group-header {
            display: flex;
            color: #666;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .level-group-title {
            display: flex;
            font-weight: 700;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 10px;
            flex: 1;
        }

        .participants-row {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .participant-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 8px 12px;
            border-radius: 20px;
            border: 2px solid #e1e5e9;
            font-size: 14px;
        }

        .participant-chip.completed {
            background: #d4edda;
            border-color: #4CAF50;
        }

        .chip-checkbox {
            width: 16px;
            height: 16px;
            border: 2px solid #ddd;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .chip-checkbox.checked {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .chip-checkbox.checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-size: 10px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 100%;
            overflow-y: auto;
        }

        .modal-content-info {
            background-color: white;
            margin: 60% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
            max-height: 100%;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            color: black;
        }

        .modal h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .modal textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            margin-bottom: 10px;
            text-align: justify;
            text-justify: inter-word;
        }

        .modalObjectiveDescription {
            text-align: justify;
        }

        #modalObjectiveDescription {
            text-align: justify;
        }

        .edit-objectives {
            margin-top: 20px;
        }

        .objective-editor {
            margin-bottom: 5px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .evaluation-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            outline: none;
            border: none;
        }

        .evaluation-title {
            display: flex;
            margin: 0 auto;
        }

        .evaluation-actions {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .objective-editor input {
            width: 100%;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        div:focus,
        button:focus {
            outline: none;
        }

        /* Optimisations mobile - √Ä ajouter √† la fin de tes styles CSS existants */

        /* Meilleure lisibilit√© sur petits √©crans */
        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            .participant-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .level-controls {
                align-self: flex-end;
            }
            
            .nav-buttons {
                flex-direction: column;
            }
            
            .nav-buttons .btn {
                margin-bottom: 5px;
            }
            
            .setup-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .setup-row label {
                min-width: auto;
                margin-bottom: 5px;
            }
            
            .participants-row {
                gap: 5px;
            }
            
            .participant-chip {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        /* √âviter le zoom sur les inputs iOS */
        input, select, textarea {
            font-size: 16px;
        }

        /* Meilleure exp√©rience tactile */
        .objective-text, .name-button {
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }

        /* Animation pour feedback tactile */
        .btn:active, .objective-checkbox:active, .chip-checkbox:active {
            transform: scale(0.95);
        }

        /* PWA sp√©cifique - masquer les √©l√©ments si install√© */
        @media (display-mode: standalone) {
            /* Styles sp√©cifiques quand l'app est install√©e */
            .header {
                padding-top: 30px; /* Compensation pour la barre de statut */
            }
    }
        
    </style>
</head>

<script>
// Enregistrement du service worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./sw.js')
      .then(function(registration) {
        console.log('Service Worker enregistr√© avec succ√®s:', registration.scope);
      })
      .catch(function(error) {
        console.log('√âchec enregistrement Service Worker:', error);
      });
  });
}

// Gestion de l'installation PWA
let deferredPrompt;
let installButton;

// Cr√©er le bouton d'installation
function createInstallButton() {
  const mainMenu = document.getElementById('mainMenu');
  if (mainMenu && !document.getElementById('installBtn')) {
    installButton = document.createElement('button');
    installButton.id = 'installBtn';
    installButton.className = 'btn btn-success';
    installButton.innerHTML = 'üì± Installer l\'application';
    installButton.style.display = 'none';
    installButton.addEventListener('click', installApp);
    
    // Ins√©rer avant le dernier bouton du menu principal
    const lastButton = mainMenu.querySelector('button:last-child');
    mainMenu.insertBefore(installButton, lastButton);
  }
}

// √âcouter l'√©v√©nement d'installation
window.addEventListener('beforeinstallprompt', (e) => {
  console.log('PWA peut √™tre install√©e');
  e.preventDefault();
  deferredPrompt = e;
  
  createInstallButton();
  if (installButton) {
    installButton.style.display = 'block';
  }
});

// Fonction d'installation
function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if (choiceResult.outcome === 'accepted') {
        console.log('Utilisateur a accept√© l\'installation');
        if (installButton) {
          installButton.style.display = 'none';
        }
      }
      deferredPrompt = null;
    });
  }
}

// Masquer le bouton si d√©j√† install√©
window.addEventListener('appinstalled', () => {
  console.log('PWA install√©e avec succ√®s');
  if (installButton) {
    installButton.style.display = 'none';
  }
  deferredPrompt = null;
});

// Initialiser le bouton au chargement
window.addEventListener('load', () => {
  createInstallButton();
});

</script>

<body>
    <div class="container">
        <div class="header">
            <h1>Objectifs Swiss Snow League</h1>
            <p>Suivi des objectifs</p>
        </div>

        <!-- Main Menu Section -->
        <div class="section active" id="mainMenu">
            <h2 style="margin-bottom: 20px; color: #2c3e50; text-align: center;">Menu principal</h2>
            <button class="btn" onclick="showCreateGroup()">üÜï Cr√©er un nouveau groupe</button>
            <button class="btn btn-secondary" onclick="showGroupList()">üìã S√©lectionner un groupe</button>
            <button class="btn btn-secondary" onclick="showObjectives()">‚ÑπÔ∏è Objectifs</button>
        </div>

        <!-- Group List Section -->
        <div class="section" id="groupListSection">
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showMainMenu()">‚Üê Menu Principal</button>
            </div>
            <h2 style="margin-bottom: 20px; color: #2c3e50;">S√©lectionner un groupe</h2>
            <div id="groupList" class="group-list"></div>
        </div>

        <!-- Create Group Section -->
        <div class="section" id="createGroupSection">
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showMainMenu()">‚Üê Menu Principal</button>
            </div>
            <h2 style="margin-bottom: 20px; color: #2c3e50;">Cr√©er groupe</h2>

            <div class="setup-row">
                <input type="text" id="groupName" placeholder="Nom du groupe">
            </div>

            <div class="setup-row">
                <select id="groupLevel">

                </select>
            </div>

            <div class="participant-list">
               <h3 style="margin-bottom: 15px;">Participants :</h3>
                <div id="participantInputs">
                    <div class="participant-item">
                        <input type="text" placeholder="Pr√©nom" class="participant-name-input">
                        <button class="btn btn-danger btn-small" onclick="removeParticipant(this)">üóë</button>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="addParticipant()">+ Ajouter Participant</button>
            </div>

            <button class="btn" onclick="createGroup()">Cr√©er le groupe & √©valuer</button>
        </div>

        <!-- Objectives View Section -->
        <div class="section" id="objectivesSection">
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showMainMenu()">‚Üê Menu principal</button>
            </div>
            <h2 style="margin-bottom: 20px; color: #2c3e50;">Objectifs par niveau</h2>

            <div class="setup-row">
                <p>Niveau :</p>
                <select id="objectivesLevel" onchange="displayObjectivesForLevel(this.value)">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>

            <div id="objectivesDisplay" style="margin-top: 20px;">
                <!-- Objectives will be displayed here -->
            </div>
        </div>

        <!-- Evaluation Section -->
        <div class="section" id="evaluationSection">
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="showGroupList()">‚Üê S√©lection de groupe</button>
                <button class="btn btn-secondary" onclick="showAddParticipant()">Ajouter participant</button>
            </div>


            <div class="evaluation-header">
                <div class="evaluation-title">
                    <h2 id="currentGroupName" style="color: #2c3e50;"></h2>
                </div>
                <div class="evaluation-actions">
                    <button class="btn btn-danger btn-small" onclick="deleteCurrentGroup()">üóë Supprimer</button>
                    <button class="btn btn-secondary btn-small" onclick="editCurrentGroup()">‚úé Modifier</button>
                </div>
            </div>


            <div class="view-toggle">
                <button id="viewByObjective" onclick="switchView('objective')">Par objectif</button>
                <button id="viewByParticipant" class="active" onclick="switchView('participant')">Par participant</button>
                
            </div>

            <div id="participantView">
                <div id="participantsList"></div>
            </div>

            <div id="objectiveView" style="display: none;">
                <div id="objectivesList"></div>
            </div>

            <div class="summary" id="classSummary"></div>
        </div>
    </div>

    

    <!-- Objective Info Modal -->
    <div id="objectiveModal" class="modal">
        <div class="modal-content-info">
            <span class="close">&times;</span>
            <h3 id="modalObjectiveTitle">D√©tail De L'Objectif</h3>
            <p id="modalObjectiveDescription"></p>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Supprimer le groupe</h3>
            <p>Etes-vous s√ªr de vouloir supprimer ce groupe ? Cette action ne pourra pas √™tre annul√©e.</p>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-danger" onclick="confirmDeleteGroup()">Supprimer</button>
                <button class="btn btn-secondary" onclick="closeModal('deleteModal')">Annuler</button>
            </div>
        </div>
    </div>

    <!-- Add Participant Modal -->
    <div id="addParticipantModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Ajouter Participant</h3>
            <div class="setup-row">
                <p>Nom:</p>
                <input type="text" id="newParticipantName" placeholder="Nom du participant">
            </div>
            <div class="setup-row">
                <p>Niveau:</p>
                <select id="newParticipantLevel">
                    <!-- Will be populated by JavaScript -->
                </select>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="addNewParticipant()">Ajouter</button>
                <button class="btn btn-secondary" onclick="closeModal('addParticipantModal')">Annuler</button>
            </div>
        </div>
    </div>

    <script>
        // Centralized level names
        const LEVEL_NAMES = {
            1: "Swiss Snow Kids Village",
            2: "Blue Prince",
            3: "Blue King/Queen",
            4: "Blue Star",
            5: "Red Prince",
            6: "Red King/Queen",
            7: "Red Star",
            8: "Black Prince",
            9: "Academy Race",
            10: "Academy Freestyle",
            11: "Academy Freeride"
        };

        // Helper function to get level display name
        function getLevelName(levelNumber) {
            return LEVEL_NAMES[levelNumber];
        }

        // Fonction pour obtenir la couleur selon le niveau
        function getLevelColor(level) {
            if (level === 1) return '#28a745'; // Vert
            if (level >= 2 && level <= 4) return '#007bff'; // Bleu  
            if (level >= 5 && level <= 7) return '#dc3545'; // Rouge
            if (level >= 8 && level <= 11) return '#343a40'; // Noir
            return '#667eea'; // Couleur par d√©faut
        }

        // Helper function to generate level options for dropdowns
        function generateLevelOptions(selectedLevel = null) {
            return Object.keys(LEVEL_NAMES).map(level => {
                const selected = selectedLevel == level ? 'selected' : '';
                return `<option value="${level}" ${selected}>${LEVEL_NAMES[level]}</option>`;
            }).join('');
        }
        // Default objective data
        const defaultObjectives = {
            1: [
                { name: "Informations sur les skis et la neige", 
                description: "Comportement ludique, dans une position debout et naturelle, en rapport avec la situation pr√©sente et le mat√©riel de ski." },
                { name: "Marcher, tourner et monter avec les skis", 
                description: "D√©placement ind√©pendant et monter avec les skis avec des aides didactiques." },
                { name: "Glisser dans la ligne de pente avec les skis parall√®les et freiner", 
                description: "Descendre dans la ligne de pente avec les skis parall√®les. Freiner, dans une certaine mesure, avec des aides didactiques." },
                { name: "Premier changement de direction depuis la ligne de pente", 
                description: "L√©ger changement de direction avec les skis parall√®les ou en chasse-neige, avec des aides didactiques." }
            ],
            2: [
                { name: "Monter en escalier et en ciseaux", 
                description: "Monter seul en escaliers et en ciseaux sans aide didactique.",
                video: "https://youtu.be/vGy7yxiKGHA?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=11" },
                { name: "Glisser et freiner en chasse-neige", 
                description: "Glisser et freiner seul avec une position de chasse-neige sym√©trique (contr√¥le de la vitesse).",
                video: "https://youtu.be/vGy7yxiKGHA?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=31" },
                { name: "Glisser avec les skis parall√®les avec des pas et des tricks", 
                description: "Dans la ligne de pente, exercices en lien avec l'√©quilibre et ex√©cut√©s de mani√®re s√ªre et contr√¥l√©e, avec et sans aide didactique.",
                video: "https://youtu.be/vGy7yxiKGHA?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=52" },
                { name: "Chasse-neige tournant", 
                description: "Virages fluides et encha√Æn√©s en position de chasse-neige.",
                video: "https://youtu.be/vGy7yxiKGHA?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=67" }
            ],
            3: [
                { name: "Descente en travers√©e et tricks", 
                description: "Travers√©e avec les skis parall√®les sur les carres amont, sans d√©raper et des 2 c√¥t√©s. Exercices contr√¥l√©s en lien avec l'√©quilibre avec et sans aide didactique.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=18" },
                { name: "D√©rapage lat√©ral", 
                description: "D√©rapage lat√©ral, des 2 c√¥t√©s, proche de la ligne de pente, avec les skis parall√®les.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=39" },
                { name: "Skier des bosses et des sauts faciles avec les skis parall√®les", 
                description: "Contr√¥le de la vitesse avant l'√©l√©ment. Passage en s√©curit√© sur le saut ou la bosse avec les skis parall√®les.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=63" },
                { name: "Virage chasse-neige sur piste bleue facile", 
                description: "Virages fluides et encha√Æn√©s en virage chasse-neige. Skis parall√®les dans la travers√©e.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=80" }
            ],                 
            4: [
                { name: "Virer dans une for√™t de mini-piquets et un parcours", 
                description: "Virer de mani√®re s√ªre et contr√¥l√©e dans une for√™t de mini-piquets et dans un parcours en respectant certaines exigences.",
                video: "https://youtu.be/RX9MyMyYEl4?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=10" },
                { name: "Skier dans les creux et bosses", 
                description: "Gr√¢ce √† des mouvements de flexion/extension des jambes, conserver le contact ski-neige. Position parall√®le des skis.",
                video: "https://youtu.be/RX9MyMyYEl4?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=45" },
                { name: "Skier en switch avec les skis en V et changer de direction", 
                description: "Skier de mani√®re fluide et contr√¥l√©e en switch avec la position des skis en V. Petits changements de direction avec des mouvements de rotation.",
                video: "https://youtu.be/RX9MyMyYEl4?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=63" },
                { name: "Virage chasse-neige sur piste bleue vari√©e", 
                description: "Descente fluide et contr√¥l√©e dans diverses formes d'organisation. Diminuer l'angle d'ouverture du chasse-neige d√®s la ligne de pente.",
                video: "https://youtu.be/RX9MyMyYEl4?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=76" }
            ],
            5: [
                { name: "Freiner en parall√®le", 
                description: "Arr√™t contr√¥l√© des deux c√¥t√©s avec les skis parall√®les et des mouvements de bascule et d'angulation. Depuis la travers√©e et la ligne de pente. Attitude de base naturelle.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=10" },
                { name: "Pas tournant sur piste facile", 
                description: "Depuis la ligne de pente, r√©aliser une suite de pas encha√Æn√©s en forme de S. Il peut y avoir de courtes phases de glisse et de d√©rapage.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=25" },
                { name: "Valse", 
                description: "Valse fluide par la gauche et par la droite avec les skis le plus parall√®le possible.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=49" },
                { name: "Virage parall√®le d√©rap√©", 
                description: "Avec une attitude de base naturelle, r√©aliser des virages parall√®les avec les phases du virage visibles.",
                video: "https://youtu.be/KXrcqeJdQ-k?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=65" }
            ],
            6: [
                { name: "Virage court sur piste facile", 
                description: "Virages courts rythm√©s avec contr√¥le de la vitesse et haut du corps stable.",
                video: "https://youtu.be/18oYJ5qexe8?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=14" },
                { name: "Pas de patineur au plat", 
                description: "Changements de pas rythm√© avec ma√Ætrise de l'√©quilibre, utilisation des b√¢tons, phase de glisse et changement d'appui visibles.",
                video: "https://youtu.be/18oYJ5qexe8?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=32" },
                { name: "Basic air (small kicker)", 
                description: "Mouvement de d√©clenchement visible avec les skis parall√®les. Phase de vol s√ªre et atterrissage avec une attitude de base stable.",
                video: "https://youtu.be/18oYJ5qexe8?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=50" },
                { name: "Virage parall√®le de diff√©rents rayons", 
                description: "Avec une attitude de base naturelle, virer avec les skis parall√®les en variant les rayons. Les mouvements associ√©s aux phases du virage sont visibles.",
                video: "https://youtu.be/18oYJ5qexe8?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=65" }
            ],
            7: [
                { name: "Virage parall√®le dans un couloir de piquets et un parcours", 
                description: "Virer en parall√®le de mani√®re contr√¥l√©e dans un espace donn√© avec des transitions aussi fluides que possible. L'utilisation des b√¢tons et les mouvements cl√©s sont visibles dans les phases du virage.",
                video: "https://youtu.be/80P5e8S6vj0?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=10" },
                { name: "Virage parall√®le d√©rap√© en switch", 
                description: "Virages encha√Æn√©s en switch avec les skis aussi parall√®les que possible. Les phases du virage sont visibles.",
                video: "https://youtu.be/80P5e8S6vj0?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=49" },
                { name: "Virage sur un ski sur piste facile", 
                description: "Virages sur un ski encha√Æn√©s en √©quilibre sur la jambe int√©rieure et ext√©rieure. Les phases du virage sont visibles et de petits appuis d'aides sont autoris√©s.",
                video: "https://youtu.be/80P5e8S6vj0?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=76" },
                { name: "Virage court sur piste de difficult√© moyenne", 
                description: "Virages courts rythm√©s avec contr√¥le de la vitesse et skis parall√®les. Attitude de base naturelle et utilisation des b√¢tons visible.",
                video: "https://youtu.be/80P5e8S6vj0?list=PLTjTiqlkvSKmwoTFgcBKGF5a0GflC1QWa&t=124" }
            ],
            8: [
                { name: "Virage court avec utilisation des b√¢tons sur piste difficile", 
                description: "Virages courts rythm√©s avec contr√¥le de la vitesse et skis parall√®les. Attitude base naturelle avec haut du corps stable. Utilisation des b√¢tons coordonn√©e et phases du virage visibles.",
                video: "https://youtu.be/UwuWyhwtcb8?t=9" },
                { name: "Sauts straights et fifty-fifty sur box", 
                description: "La forme de saut est annonc√©e √† l'avance et est d√©montr√©e. Phases de vol et d'atterrissage s√ªres avec une attitude de base stable. Sauter longitudinalement sur le box et glisser avec les skis parall√®les et √† plat.",
                video: "https://youtu.be/UwuWyhwtcb8?t=27" },
                { name: "Virage parall√®le en neige non pr√©par√©e", 
                description: "Descente fluide et contr√¥l√©e avec les skis parall√®les en variant les rayons. Les phases du virage sont visibles.",
                video: "https://youtu.be/UwuWyhwtcb8?t=47" },
                { name: "Carving (virage parall√®le coup√©) sur piste large et facile", 
                description: "Virages parall√®les coup√©s au moins avec le ski ext√©rieur (contr√¥le de la vitesse). Attitude base naturelle et phases du virage visibles.",
                video: "https://youtu.be/UwuWyhwtcb8?t=85" }
            ],
            9: [
                { name: "Virage parall√®le de comp√©tition race", 
                description: "Attitude de base dynamique avec haut du corps stable. Mouvements cl√©s et fonctions des skis visibles dans les phases du virage. Utilisation du drift et de la position de recherche de vitesse selon la situation." },
                { name: "Virage court de comp√©tition race", 
                description: "Attitude de base dynamique avec haut du corps stable. Mouvements cl√©s et fonctions des skis visibles dans les phases du virage." },
                { name: "Variantes de virage", 
                description: "Virages coup√©s avec augmentation active de l'angle de prise de carre par un d√©placement lat√©ral du corps (bascule/angulation). Contr√¥le de la vitesse par la fermeture des virages." },
                { name: "Technique de comp√©tition dans un parcours donn√©", 
                description: "Application de la technique de comp√©tition en slalom g√©ant et en slalom dans un parcours donn√©." },
                { name: "Saut group√©", 
                description: "D√©clenchement avec les deux jambes et traction active des jambes sous le corps. Phases de vol et d'atterrissage s√ªres avec une attitude de base stable." },
                { name: "Entra√Ænement ou comp√©tition", 
                description: "Choix de la ligne adapt√© √† la situation. Mise en ≈ìuvre des racing basics." }
            ],
            10: [
                { name: "Virage parall√®le switch", 
                description: "Virages parall√®les encha√Æn√©s d√©rap√©s ou coup√©s, contr√¥le de la vitesse par la fermeture des virages. Position parall√®le des skis." },
                { name: "Saut droit avec grab (min. 2 grabs)", 
                description: "Annoncer le grab avant le saut et le d√©montrer ensuite (min. 2 grabs diff√©rents)." },
                { name: "Air trick spins (180¬∞/360¬∞)", 
                description: "D√©clenchement visible et phases de vol et d'atterrissage s√ªres avec une attitude de base stable." },
                { name: "Tricks sur piste (180¬∞, su√©dois 180¬∞)", 
                description: "180¬∞ - Phase en l'air visible. Su√©dois 180¬∞ - Changement de direction complet sur le nose et le tail gr√¢ce √† un cisaillement des jambes." },
                { name: "Rotation sur box ou rail", 
                description: "Valse sur le box. Glisse s√ªre et contr√¥l√©e ainsi que la sortie. Rotation de 90¬∞ on/off sur rail." },
                { name: "Pipe basic run ou Ski-cross", 
                description: "Descente contr√¥l√©e dans le pipe avec d√©clenchement et atterrissage dans le vertical. Position parall√®le des skis. - Ski-cross : Passage s√ªr des √©l√©ments. Fluidit√© et vitesse adapt√©es aux √©l√©ments." },               
            ],
            11: [
                { name: "Recherche DVA, Lecture du bulletin avalanche, choix de la ligne et des points d'arr√™t", 
                description: "L'√©l√®ve peut se servir du DVA et retrouver une personne ensevelie. L'√©l√®ve conna√Æt les degr√©s de danger et peut les interpr√©ter. L'√©l√®ve conna√Æt la signification d'une ligne s√ªre et des points d'arr√™t." },
                { name: "Virage parall√®le hors-piste avec variations de rayons", 
                description: "Contr√¥le de la vitesse par l'adaptation des phases du virage. Attitude de base dynamique avec haut du corps stable." },
                { name: "Traces cr√©atives/Powder 8", 
                description: "Gr√¢ce √† une descente synchronis√©e et sym√©trique les traces dessin√©es sont visibles." },
                { name: "Virage court dans les bosses", 
                description: "Position parall√®le et serr√©e des skis avec haut du corps stable. Rythme des mouvements adapt√©s aux bosses. Int√©gration de l'utilisation des b√¢tons comme aide pour le rythme." },
                { name: "Saut de terrain ou construit", 
                description: "Passage en s√©curit√© des obstacles naturels. Vitesse adapt√©e aux obstacles. Phases de vol et d'atterrissage adapt√©es avec une attitude de base stable." },
                { name: "Descente hors-piste cr√©ative", 
                description: "Attitude de base dynamique avec haut du corps stable. Passage en s√©curit√© des obstacles naturels et vitesse adapt√©e. La descente hors-piste doit √™tre contr√¥l√©e et les virages adapt√©s au terrain." }
            ],
        };

        let groups = {};
        let currentGroupId = null;
        let objectives = {};
        let currentView = 'participant';
        let isEditMode = false;

        // Load data from storage
        function loadData() {
            const savedObjectives = JSON.parse(localStorage.getItem('skiObjectives') || 'null');
            const savedGroups = JSON.parse(localStorage.getItem('skiGroups') || 'null');
            const savedCurrentGroup = localStorage.getItem('currentGroupId');

            objectives = savedObjectives || JSON.parse(JSON.stringify(defaultObjectives));
            groups = savedGroups || {};
            currentGroupId = savedCurrentGroup;

            // Fix completedObjectives Sets after loading from localStorage
            Object.keys(groups).forEach(groupId => {
                groups[groupId].participants.forEach(participant => {
                    if (!participant.completedObjectives) {
                        participant.completedObjectives = new Set();
                    } else if (Array.isArray(participant.completedObjectives)) {
                        // Convert array back to Set (localStorage converts Sets to arrays)
                        participant.completedObjectives = new Set(participant.completedObjectives);
                    } else if (participant.completedObjectives.constructor !== Set) {
                        participant.completedObjectives = new Set();
                    }
                });
            });
            validateGroupData();
        }

        // Validate and fix group data structure
        function validateGroupData() {
            if (!groups || typeof groups !== 'object') {
                groups = {};
                return;
            }

            Object.keys(groups).forEach(groupId => {
                const group = groups[groupId];

                if (!group || typeof group !== 'object') {
                    delete groups[groupId];
                    return;
                }

                // Ensure group has a level property
                if (!group.level || isNaN(group.level)) {
                    group.level = 2; // Default to Blue Prince if missing
                }

                // Ensure participants array exists
                if (!Array.isArray(group.participants)) {
                    group.participants = [];
                }

                // Ensure all participants have level property
                group.participants.forEach((participant, index) => {
                    if (!participant || typeof participant !== 'object') {
                        group.participants[index] = {
                            id: index + 1,
                            name: 'Unknown Participant',
                            level: group.level,
                            completedObjectives: new Set()
                        };
                        return;
                    }

                    if (!participant.level || isNaN(participant.level)) {
                        participant.level = group.level; // Use group level as default
                    }

                    if (!participant.name) {
                        participant.name = `Participant ${index + 1}`;
                    }

                    if (!participant.id) {
                        participant.id = index + 1;
                    }
                });
            });
        }

        // Save data to storage
        function saveData() {
            // Convert Sets to arrays before saving (localStorage can't handle Sets directly)
            const groupsToSave = {};
            Object.keys(groups).forEach(groupId => {
                groupsToSave[groupId] = {
                    ...groups[groupId],
                    participants: groups[groupId].participants.map(participant => ({
                        ...participant,
                        completedObjectives: Array.from(participant.completedObjectives || [])
                    }))
                };
            });

            localStorage.setItem('skiObjectives', JSON.stringify(objectives));
            localStorage.setItem('skiGroups', JSON.stringify(groupsToSave));
            if (currentGroupId) {
                localStorage.setItem('currentGroupId', currentGroupId);
            }
        }

        // Navigation functions
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        function showMainMenu() {
            showSection('mainMenu');

        }
     
        function showCreateGroup() {
            isEditMode = false;
            resetCreateGroupForm();

            showSection('createGroupSection');
            // Reset form
            document.getElementById('groupName').value = '';
            document.getElementById('groupLevel').innerHTML = generateLevelOptions(2);
            const participantInputsHTML = `
                <div class="participant-item">
                    <input type="text" placeholder="Pr√©nom" class="participant-name-input">
                    <button class="btn btn-danger btn-small m-0" onclick="removeParticipant(this)">Supprimer</button>
                </div>
            `;
            document.getElementById('participantInputs').innerHTML = participantInputsHTML;

            // Add Enter key listener to the initial input
            const initialInput = document.querySelector('#participantInputs .participant-name-input');
            addEnterKeyListener(initialInput);
        }

        function showObjectives() {
            showSection('objectivesSection');
            
            // Populate level dropdown
            document.getElementById('objectivesLevel').innerHTML = generateLevelOptions(1);
            
            // Show objectives for level 1 by default
            displayObjectivesForLevel(1);
        }

        function displayObjectivesForLevel(level) {
            const container = document.getElementById('objectivesDisplay');
            const levelObjectives = defaultObjectives[level] || [];
            
            if (levelObjectives.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Aucun objectif d√©fini pour ce niveau</p></div>';
                return;
            }
            
            container.innerHTML = levelObjectives.map(objective => `
                <div class="objective-item" style="display: block; background: white; border: 1px solid #e1e5e9; margin-bottom: 15px; padding: 15px; border-radius: 8px;">
                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 16px;">
                        ${objective.name}
                    </div>
                    <div style="color: #666; font-size: 14px; line-height: 1.4;">
                        ${objective.description}
                    </div>
                    ${objective.video ? `
                    <div style="margin-top: 10px; text-align: center;">
                        <a href="${objective.video}" target="_blank" rel="noopener noreferrer" style="color: #e74c3c; text-decoration: none; font-size: 14px; display: inline-flex; align-items: center; gap: 5px;">
                            üìπ Voir la vid√©o
                        </a>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function editCurrentGroup() {
            if (!currentGroupId || !groups[currentGroupId]) {
                alert('No group selected');
                return;
            }

            isEditMode = true;
            const group = groups[currentGroupId];

            // Populate the form with existing data
            document.getElementById('groupName').value = group.name;
            document.getElementById('groupLevel').value = group.level;

            // Clear and populate participants
            const container = document.getElementById('participantInputs');
            container.innerHTML = '';

            group.participants.forEach((participant, index) => {
                const participantDiv = document.createElement('div');
                participantDiv.className = 'participant-item';
                participantDiv.innerHTML = `
                    <input type="text" placeholder="Participant name" class="participant-name-input" value="${participant.name}" data-participant-id="${participant.id}">
                    <button class="btn btn-danger btn-small" onclick="removeParticipant(this)">Supprimer</button>
                `;
                container.appendChild(participantDiv);

                // Add Enter key listener
                const input = participantDiv.querySelector('.participant-name-input');
                addEnterKeyListener(input);
            });

            // Add one empty field for new participants
            addParticipant();

            // Changement du bouton de validation
            const submitBtn = container.parentElement.parentElement.querySelector('button[onclick="createGroup()"]');
            submitBtn.textContent = 'Sauvegarder les modifications';
            submitBtn.onclick = saveGroupEdits;

            // Changer le bouton de navigation en haut
            const navBtn = document.querySelector('#createGroupSection .nav-buttons button[onclick="showMainMenu()"]');
            if (navBtn) {
                navBtn.textContent = '‚Üê Retour √† l\'√©valuation';
                navBtn.onclick = function() { 
                    if (confirm('Sauvegarder les modifications avant de retourner ?')) {
                        saveGroupEdits();
                    } else {
                        showEvaluation();
                    }
                };
            }

            // Change section title
            document.querySelector('#createGroupSection h2').textContent = 'Modifier le groupe';

            showSection('createGroupSection');
        }

        function saveGroupEdits() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupLevel = parseInt(document.getElementById('groupLevel').value);
            const nameInputs = document.querySelectorAll('.participant-name-input');

            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            const group = groups[currentGroupId];
            const oldParticipants = [...group.participants]; // Keep reference for progress preservation

            // Update group info
            group.name = groupName;
            group.level = groupLevel;

            // Process participants
            const newParticipants = [];
            let maxId = Math.max(...oldParticipants.map(p => p.id), 0);

            nameInputs.forEach(input => {
                const name = input.value.trim();
                if (name) {
                    const participantId = input.dataset.participantId;

                    if (participantId) {
                        // Existing participant - preserve progress but update name and level
                        const existingParticipant = oldParticipants.find(p => p.id == participantId);
                        if (existingParticipant) {
                            newParticipants.push({
                                ...existingParticipant,
                                name: name,
                                level: groupLevel // Apply group level change
                            });
                        }
                    } else {
                        // New participant
                        maxId++;
                        newParticipants.push({
                            id: maxId,
                            name: name,
                            level: groupLevel,
                            completedObjectives: new Set()
                        });
                    }
                }
            });

            if (newParticipants.length === 0) {
                alert('Please enter at least one participant name');
                return;
            }

            // Update group with new participants list
            group.participants = newParticipants;

            // Reset form state
            resetCreateGroupForm();
            isEditMode = false;

            saveData();
            showEvaluation();
        }



        function resetCreateGroupForm() {
            // Reset the main action button (the one that creates/saves)
            const createBtn = document.querySelector('#createGroupSection button[onclick*="createGroup"], #createGroupSection button[onclick*="saveGroupEdits"]');
            if (createBtn) {
                createBtn.textContent = 'Cr√©er le groupe & √©valuer';
                createBtn.onclick = createGroup;
            }

            // Remettre le bouton de navigation original
            const navBtn = document.querySelector('#createGroupSection .nav-buttons button');
            if (navBtn) {
                navBtn.textContent = '‚Üê Menu Principal';
                navBtn.onclick = showMainMenu;
            }

            // Reset section title
            document.querySelector('#createGroupSection h2').textContent = 'Cr√©er groupe';
        }

        function showGroupList() {
            showSection('groupListSection');
            renderGroupList();
        }

        function renderGroupList() {
            const container = document.getElementById('groupList');
            const groupIds = Object.keys(groups);

            if (groupIds.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No Groups Yet</h3>
                        <p>Create your first group to get started!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = groupIds.map(groupId => {
                const group = groups[groupId];

                // Safe fallbacks for missing properties
                const groupLevel = group.level || 2;
                const participantCount = (group.participants && group.participants.length) || 0;
                const groupName = group.name || 'Unnamed Group';

                return `
                    <div class="group-item" onclick="selectGroup('${groupId}')">
                        <div class="group-name">${group.name}</div>
                        <div class="group-info">
                            <span>${group.participants.length} participants ‚Ä¢</span><span style="color: ${getLevelColor(groupLevel)}">${getLevelName(groupLevel)}</span>
                            <div class="group-actions" onclick="event.stopPropagation()">
                                <button class="btn btn-danger btn-small" onclick="deleteGroup('${groupId}')">Supprimer</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function addParticipant() {
            const container = document.getElementById('participantInputs');
            const participantDiv = document.createElement('div');
            participantDiv.className = 'participant-item';
            participantDiv.innerHTML = `
                <input type="text" placeholder="Pr√©nom" class="participant-name-input">
                <button class="btn btn-danger btn-small" onclick="removeParticipant(this)">Supprimer</button>
            `;
            container.appendChild(participantDiv);
            // Add Enter key listener to the new input
            const newInput = participantDiv.querySelector('.participant-name-input');
            addEnterKeyListener(newInput);
        }

        function addEnterKeyListener(inputElement) {
            inputElement.addEventListener('keypress', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission

                    const currentValue = this.value.trim();
                    if (currentValue !== '') {
                        // Add new participant field
                        addParticipant();

                        // Focus on the new input field
                        const allInputs = document.querySelectorAll('#participantInputs .participant-name-input');
                        const lastInput = allInputs[allInputs.length - 1];
                        lastInput.focus();
                    }
                }
            });
        }

        function removeParticipant(button) {
            const container = document.getElementById('participantInputs');
            if (container.children.length > 1) {
                button.parentElement.remove();
            }
        }
        function getSmartGroupName(originalName) {
            const existingGroups = Object.values(groups);
            const today = new Date();
            const todayStr = today.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const timeStr = today.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });

            // Check if name exists
            const exactMatch = existingGroups.find(g => g.name === originalName);
            if (!exactMatch) {
                // First time using this name - keep it clean
                return originalName;
            }

            // Check for same-day duplicates
            const todayGroups = existingGroups.filter(g => {
                const groupDate = new Date(g.createdAt);
                return groupDate.toDateString() === today.toDateString() &&
                    g.name.startsWith(originalName);
            });

            if (todayGroups.length > 0) {
                // Same day duplicate - add time
                return `${originalName} (${timeStr})`;
            } else {
                // Different day - add date
                return `${originalName} (${todayStr})`;
            }
        }

        function createGroup() {
            const groupName = document.getElementById('groupName').value.trim();
            const groupLevel = parseInt(document.getElementById('groupLevel').value);
            const nameInputs = document.querySelectorAll('.participant-name-input');

            if (!groupName) {
                alert('Please enter a group name');
                return;
            }

            const participants = [];
            nameInputs.forEach((input, index) => {
                const name = input.value.trim();
                if (name) {
                    participants.push({
                        id: index + 1,
                        name: name,
                        level: groupLevel,
                        completedObjectives: new Set()
                    });
                }
            });

            if (participants.length === 0) {
                alert('Veuillez entrer au moins un pr√©nom.');
                return;
            }

            const groupId = Date.now().toString();
            groups[groupId] = {
                id: groupId,
                name: getSmartGroupName(groupName),
                level: groupLevel,
                participants: participants,
                createdAt: new Date().toISOString()
            };

            currentGroupId = groupId;
            saveData();
            showEvaluation();
        }

        function selectGroup(groupId) {
            currentGroupId = groupId;
            saveData();
            showEvaluation();
        }

        function showEvaluation() {
            if (!currentGroupId || !groups[currentGroupId]) {
                alert('No group selected');
                return;
            }

            showSection('evaluationSection');
            document.getElementById('currentGroupName').textContent = groups[currentGroupId].name;
            switchView(currentView);
        }

        function switchView(viewType) {
            currentView = viewType;

            document.getElementById('viewByParticipant').classList.toggle('active', viewType === 'participant');
            document.getElementById('viewByObjective').classList.toggle('active', viewType === 'objective');

            document.getElementById('participantView').style.display = viewType === 'participant' ? 'block' : 'none';
            document.getElementById('objectiveView').style.display = viewType === 'objective' ? 'block' : 'none';

            if (viewType === 'participant') {
                renderParticipants();
            } else {
                renderObjectives();
            }
            updateClassSummary();
        }

        function renderParticipants() {
            const container = document.getElementById('participantsList');
            const group = groups[currentGroupId];
            container.innerHTML = '';

            group.participants.forEach(participant => {
                const card = createParticipantCard(participant);
                container.appendChild(card);
            });
        }

        function renderObjectives() {
            const container = document.getElementById('objectivesList');
            const group = groups[currentGroupId];

            // Group participants by level
            const participantsByLevel = {};
            group.participants.forEach(participant => {
                if (!participantsByLevel[participant.level]) {
                    participantsByLevel[participant.level] = [];
                }
                participantsByLevel[participant.level].push(participant);
            });

            container.innerHTML = '';

            // Get objectives for main group level
            const mainLevelObjectives = defaultObjectives[group.level] || [];

            mainLevelObjectives.forEach((objective, objectiveIndex) => {
                const section = document.createElement('div');
                section.className = 'objective-section';

                section.innerHTML = `
                    ${Object.keys(participantsByLevel).map(level => {
                    const levelParticipants = participantsByLevel[level];
                    const levelObjectives = defaultObjectives[level] || [];
                    const levelObjective = levelObjectives[objectiveIndex];

                    if (!levelObjective) return '';

                    return `
                        <div class="level-group">
                            <div class="level-group-header">
                                <div class="level-group-title">${levelObjective.name}</div>
                                <div class="info-icon" data-obj-name="${levelObjective.name}" data-obj-desc="${levelObjective.description}" onclick="showObjectiveInfoFromData(this)">i</div>
                            </div>
                                <div class="participants-row">
                                ${levelParticipants.map(participant => `
                                    <div class="participant-chip ${participant.completedObjectives.has(objectiveIndex) ? 'completed' : ''}">
                                        <div class="chip-checkbox ${participant.completedObjectives.has(objectiveIndex) ? 'checked' : ''}" 
                                                onclick="toggleObjectiveInView(${participant.id}, ${objectiveIndex})"></div>
                                        <span class="name-button" onclick="toggleObjectiveInView(${participant.id}, ${objectiveIndex})" >${participant.name}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('')}
                `;

                container.appendChild(section);
            });
        }

        function createParticipantCard(participant) {
            const card = document.createElement('div');
            card.className = 'participant-card';
            card.style.borderLeftColor = getLevelColor(participant.level)

            const levelObjectives = defaultObjectives[participant.level] || [];
            const completed = participant.completedObjectives.size;
            const total = levelObjectives.length;
            const progress = total > 0 ? (completed / total) * 100 : 0;

            card.innerHTML = `
                <div class="participant-header">
                    <span class="participant-name">${participant.name}</span>
                    <div class="level-controls">
                        <select class="level-select" onchange="changeParticipantLevel(${participant.id}, this.value)">
                            ${generateLevelOptions(participant.level)}
                        </select>
                    </div>
                </div>
                <div class="objectives-grid">
                    ${levelObjectives.map((objective, i) => `
                        <div class="objective-item">
                            <div class="objective-checkbox ${participant.completedObjectives.has(i) ? 'checked' : ''}" 
                                 onclick="toggleObjective(${participant.id}, ${i})"></div>
                            <span class="objective-text" onclick="toggleObjective(${participant.id}, ${i})">${objective.name}</span>
                            <div class="info-icon" data-obj-name="${objective.name}" data-obj-desc="${objective.description}" onclick="showObjectiveInfoFromData(this)">i</div>
                            
                        </div>
                    `).join('')}
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progress}%"></div>
                </div>
                
            `;

            return card;
        }

        function changeParticipantLevel(participantId, newLevel) {
            const group = groups[currentGroupId];
            const participant = group.participants.find(p => p.id === participantId);
            participant.level = parseInt(newLevel);
            participant.completedObjectives.clear(); // Reset objectives when level changes
            saveData();

            if (currentView === 'participant') {
                renderParticipants();
            } else {
                renderObjectives();
            }
            updateClassSummary();
        }

        function toggleObjective(participantId, objectiveIndex) {
            const group = groups[currentGroupId];
            const participant = group.participants.find(p => p.id === participantId);

            if (participant.completedObjectives.has(objectiveIndex)) {
                participant.completedObjectives.delete(objectiveIndex);
            } else {
                participant.completedObjectives.add(objectiveIndex);
            }

            saveData();

            if (currentView === 'participant') {
                renderParticipants();
            } else {
                renderObjectives();
            }
            updateClassSummary();
        }

        function toggleObjectiveInView(participantId, objectiveIndex) {
            toggleObjective(participantId, objectiveIndex);
        }

        function showObjectiveInfoFromData(element) {
            const name = element.dataset.objName;
            const description = element.dataset.objDesc;
            showObjectiveInfo(name, description);
        }

        function updateClassSummary() {
            const group = groups[currentGroupId];
            const totalObjectives = group.participants.reduce((sum, p) => sum + (defaultObjectives[p.level] || []).length, 0);
            const completedObjectives = group.participants.reduce((sum, p) => sum + p.completedObjectives.size, 0);
            const overallProgress = totalObjectives > 0 ? Math.round((completedObjectives / totalObjectives) * 100) : 0;

            document.getElementById('classSummary').innerHTML = `
                Progr√®s du groupe : ${overallProgress}%
            `;
        }

        function deleteGroup(groupId) {
            if (confirm('Etes-vous s√ªr de vouloir supprimer ce groupe ?')) {
                delete groups[groupId];
                if (currentGroupId === groupId) {
                    currentGroupId = null;
                    localStorage.removeItem('currentGroupId');
                }
                saveData();
                renderGroupList();
            }
        }

        function deleteCurrentGroup() {
            document.getElementById('deleteModal').style.display = 'block';
        }

        function confirmDeleteGroup() {
            if (currentGroupId && groups[currentGroupId]) {
                delete groups[currentGroupId];
                localStorage.removeItem('currentGroupId');
                currentGroupId = null;
                saveData();
                closeModal('deleteModal');
                showMainMenu();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAddParticipant() {
            if (!currentGroupId || !groups[currentGroupId]) {
                alert('No group selected');
                return;
            }

            const group = groups[currentGroupId];
            document.getElementById('newParticipantName').value = '';
            document.getElementById('newParticipantLevel').innerHTML = generateLevelOptions(group.level);
            document.getElementById('addParticipantModal').style.display = 'block';
            // Add Enter key listener

                // Ajouter l'addEventListener seulement apr√®s avoir affich√© le modal
                const nameInput = document.getElementById('newParticipantName');
                if (nameInput && !nameInput.hasEnterListener) {
                    nameInput.addEventListener('keypress', function (event) {
                        if (event.key === 'Enter') {
                            event.preventDefault();
                            addNewParticipant();
                        }
                    });
                    nameInput.hasEnterListener = true;
                }
            }

        function addNewParticipant() {
            const name = document.getElementById('newParticipantName').value.trim();
            const level = parseInt(document.getElementById('newParticipantLevel').value);

            if (!name) {
                alert('Veuillez entrer un nom');
                return;
            }

            const group = groups[currentGroupId];
            const newId = Math.max(...group.participants.map(p => p.id), 0) + 1;

            const newParticipant = {
                id: newId,
                name: name,
                level: level,
                completedObjectives: new Set()
            };

            group.participants.push(newParticipant);
            saveData();

            // Refresh the current view
            if (currentView === 'participant') {
                renderParticipants();
            } else {
                renderObjectives();
            }
            updateClassSummary();

            closeModal('addParticipantModal');
        }

        function showObjectiveInfo(name, description) {
            document.getElementById('modalObjectiveTitle').textContent = name;
            document.getElementById('modalObjectiveDescription').textContent = description;
            document.getElementById('objectiveModal').style.display = 'block';
        }


        // Modal controls
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function () {
                this.closest('.modal').style.display = 'none';
            }
        });

        window.onclick = function (event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            loadData();

             // Populate level dropdowns avec v√©rification
            const groupLevelSelect = document.getElementById('groupLevel');
            if (groupLevelSelect) {
                groupLevelSelect.innerHTML = generateLevelOptions(2);
            }
            
            
            // modifi√© pour que menu principal si rechargement (supprimer 3 commentaires suivants si besoin de modif):If there's a current group, go directly to evaluation
            // if (currentGroupId && groups[currentGroupId]) {
            //    showEvaluation();
            //}
        });
    </script>
</body>

</html>